.container.mule-panel.movers{"data-ng-app" => "mule", "data-ng-controller" => "MoversListCtrl"}
  .col-md-3.hidden-xs.hidden-sm
    = render partial: "movers_list_sidebar"

  .col-md-9.col-xs-12
    .from-to.col-xs-3
      Your Move From:
      %strong= " #{@from.titleize} â†’ #{@to.titleize}"
    .dropdown.services-dropdown.col-xs-3
      %li.dropdown
        %a.dropdown-toggle{"data-toggle" => "dropdown", href: "#"}
          Schedule
          %b.caret
        %ul.dropdown-menu.unstyled.pull-left.dropdown-features
          %li
            %div.filter-panel
              %h4
                Insurance
              %ul.list-unstyled
                %li{"data-ng-repeat" => "insurance in insurances"}
                  %input{type: :checkbox, id: "{{ insurance.id }}", name: "{{ insurance.id }}", "data-ng-model" => "filters[insurance.id]"}
                  %label{for: "{{ insurance.id }}"} {{ insurance.name }}
          %li
            %div.filter-panel{"data-ng-repeat" => "service in services"}
              %h4
                {{ service.category }} Services
              %ul.list-unstyled{"data-ng-repeat" => "item in service.items"}
                %li
                  %input{type: :checkbox, id: "{{ item.id }}", name: "{{ item.id }}", "data-ng-model" => "filters[item.id]"}
                  %label{for: "{{ item.id }}"} {{ item.name }}
    .display-count.col-xs-3
      = "displaying {{ filteredMovers.length }} of #{@mover_list_items.size} movers"
    = render partial: "mover_list_items"

:javascript
  var app = angular.module("mule", ["textHelpers"]);

  app.controller("MoversListCtrl", function($scope, FilterService) {
    $scope.moverListItems = #{@mover_list_items.to_json}
    $scope.filters = {}
    $scope.services = FilterService.getServices();
    $scope.insurances = FilterService.getInsurances();
  });

  app.factory("FilterService", function () {
    var services = #{@services.to_json}

    var insurances = [
      {id: "cargo_insurance", name: "Cargo Insurance"},
      {id: "automobile_insurance", name: "Automobile Insurance"},
      {id: "workers_compensation", name: "Workers Compensation"},
      {id: "general_liability_insurance", name: "General Liability Insurance"},
    ]

    var getInsurances = function () {
      return insurances;
    }

    var getServices = function () {
      return services;
    }

    return {
      getServices: getServices,
      getInsurances: getInsurances
    }
  })

  app.filter("serviceFilter", function($filter) {
    return function(moverListItems, filters) {

      // exclude services set to false
      var requestedFilters = {}
      $.each(filters, function(key, val) {
        if (val === true) {
          requestedFilters[key] = true
        }
      });

      return $filter("filter")(moverListItems, requestedFilters);
    }
  });